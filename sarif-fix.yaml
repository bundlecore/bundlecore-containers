      - name: Prepare SARIF files for upload
        if: steps.batch-scan.outputs.successful-scans > 0
        id: prepare-sarif
        run: |
          echo "Combining SARIF files for GitHub Security upload..."

          # Create consolidated SARIF directory
          mkdir -p sarif-upload
          SARIF_COUNT=0
          TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)

          # Count SARIF files
          for sarif_file in trivy-results/*.sarif; do
            if [ -f "$sarif_file" ]; then
              SARIF_COUNT=$((SARIF_COUNT + 1))
            fi
          done

          if [ "$SARIF_COUNT" -eq 0 ]; then
            echo "No SARIF files found to upload"
            echo "sarif-count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found $SARIF_COUNT SARIF files to combine"

          # Create combined SARIF file with proper JSON structure
          COMBINED_SARIF="sarif-upload/trivy-combined-scan-${TIMESTAMP}.sarif"
          
          # Initialize combined SARIF with empty runs array
          echo '{
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": []
          }' > "$COMBINED_SARIF"

          # Combine all runs from individual SARIF files
          echo "Combining SARIF runs into single file..."
          for sarif_file in trivy-results/*.sarif; do
            if [ -f "$sarif_file" ]; then
              echo "  → Adding runs from: $(basename "$sarif_file")"
              
              # Add metadata to the run and append to combined file
              jq --slurpfile combined "$COMBINED_SARIF" \
                 --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                 --arg workflow_run "${{ github.run_id }}" \
                 --arg repository "${{ github.repository }}" \
                 --arg image_file "$(basename "$sarif_file")" \
                 '
                 # Add metadata to this run
                 .runs[0].properties = {
                   "workflow_run": $workflow_run,
                   "repository": $repository,
                   "scan_timestamp": $timestamp,
                   "source_file": $image_file
                 } |
                 # Combine with existing runs
                 $combined[0] | .runs += [.runs[0]]
                 ' "$sarif_file" > "${COMBINED_SARIF}.tmp"
              
              mv "${COMBINED_SARIF}.tmp" "$COMBINED_SARIF"
            fi
          done

          # Validate the combined SARIF file
          if jq empty "$COMBINED_SARIF" 2>/dev/null; then
            TOTAL_RUNS=$(jq -r '.runs | length' "$COMBINED_SARIF")
            TOTAL_VULNS=$(jq -r '[.runs[].results | length] | add' "$COMBINED_SARIF")
            echo "✓ Combined SARIF file created successfully"
            echo "  → Total runs: $TOTAL_RUNS"
            echo "  → Total vulnerabilities: $TOTAL_VULNS"
            echo "  → File: $(basename "$COMBINED_SARIF")"
            
            echo "sarif-count=1" >> $GITHUB_OUTPUT
          else
            echo "✗ Failed to create valid combined SARIF file"
            echo "sarif-count=0" >> $GITHUB_OUTPUT
          fi