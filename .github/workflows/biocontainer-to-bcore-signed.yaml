name: Retag and Sign BioContainer Images
# This workflow is triggered by a push to the biocontainers directory or manually 
on:
  workflow_dispatch:
  push:
    paths:
      - 'bfx/**'

jobs:
  retag-sign:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag and sign images
        env:
          GHCR_ORG: ${{ github.repository_owner }}
          BCORE_AUTH_TOKEN: ${{ secrets.BCORE_AUTH_TOKEN }}
          PROD_DOMAIN: bfx
        run: |
          set -e
          for appdir in bfx/*/; do
            app=$(basename "$appdir")
            slug=$(basename "$appdir" | tr '[:upper:]' '[:lower:]')
            release_json="${appdir}release.json"
            if [ ! -f "$release_json" ]; then
              echo "No release.json for $app, skipping"
              continue
            fi
            images=$(jq -r '.images[]' "$release_json")
            for img in $images; do
                tag="${img##*:}"
                # remove everything after '--' (e.g. '1.21--h3a4d415_1' -> '1.21')
                tag="${tag%%--*}"
              dest="ghcr.io/${GHCR_ORG}/products/${PROD_DOMAIN}/${slug}:${tag}"
              if docker manifest inspect "$dest" > /dev/null 2>&1; then
                  echo "Image $dest already exists, skipping"
                  continue
              fi
              echo "Processing $img -> $dest"
              docker pull "$img"
              docker tag "$img" "$dest"
              docker push "$dest"
              cosign sign --yes "$dest"

                  ## TODO: Update the image via bcore API
                  # curl -X POST "https://bundlecore.com/api/tools/${slug}" \
                  #      -H "Authorization: Bearer ${BCORE_AUTH_TOKEN}" \
                  #      -H "Content-Type: application/json" \
                  #      -d "{\"image\": \"${dest}\", \"tag\": \"${tag}\"}"

                #  curl -X PUT \
                # 'https://your-domain.com/api/tools/star/versions/2.7.11a--h0033a41_0' \
                # -H 'Authorization: Bearer YOUR_API_KEY' \
                # -H 'Content-Type: application/json' \
                # -d '{
                #   "registryUrl": "quay.io/biocontainers/star:2.7.11a--h0033a41_0",
                #   "entryCmds": [],
                #   "commands": ["STAR", "STARlong"]
                # }'

            done
            # remove specific image(s) created for the slug (replace SLUG_IMAGE with your image/tag variable if needed)
            docker image rm "${{ env.SLUG_IMAGE:-slug-image:latest }}" 2>/dev/null || true
            # remove any image referenced by current workflow (optional)
            docker image rm "${{ github.sha }}" 2>/dev/null || true
            # remove build cache, dangling images and unused data to free disk
            docker builder prune -af || true
            docker image prune -af || true
            docker system prune -af --volumes || true
          done
