name: Trivy Security Scan
# ‚îÄ‚îÄ‚îÄ Triggers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# 1. After retag workflow ‚Üí scan only the tool(s) whose release.json changed
# 2. Monthly cron         ‚Üí full scan of all tools
# 3. Manual dispatch      ‚Üí all or changed-only
on:
  workflow_run:
    workflows: ["Retag and Sign BioContainer Images"]
    types: [completed]
    branches: [main]
  schedule:
    - cron: "0 2 1-7 * 0"       # First Sunday of every month, 2 AM UTC
  workflow_dispatch:
    inputs:
      scan_mode:
        description: "Scan scope"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - changed-only

permissions:
  contents: write
  packages: read
  pull-requests: write
  actions: read

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
jobs:

  # ‚îÄ‚îÄ Job 1: Figure out which tools to scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  detect-scope:
    name: Detect Scan Scope
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      tools-json: ${{ steps.scope.outputs.tools-json }}
      tool-count: ${{ steps.scope.outputs.tool-count }}
      scan-all:   ${{ steps.scope.outputs.scan-all }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Determine tools to scan
        id: scope
        run: |
          EVENT="${{ github.event_name }}"
          SCAN_MODE="${{ github.event.inputs.scan_mode }}"

          echo "üîç Trigger: $EVENT  |  scan_mode: ${SCAN_MODE:-N/A}"

          # ‚îÄ‚îÄ Full scan: schedule or manual "all" ‚îÄ‚îÄ
          if [ "$EVENT" = "schedule" ] || { [ "$EVENT" = "workflow_dispatch" ] && [ "$SCAN_MODE" != "changed-only" ]; }; then
            echo "üìã Full scan ‚Äî collecting all bfx/ tools"
            TOOLS_JSON=$(find bfx -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | jq -R . | jq -sc .)
            COUNT=$(echo "$TOOLS_JSON" | jq length)
            echo "  ‚Üí $COUNT tools"
            echo "scan-all=true"          >> $GITHUB_OUTPUT
            echo "tool-count=$COUNT"      >> $GITHUB_OUTPUT
            echo "tools-json=$TOOLS_JSON" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ‚îÄ‚îÄ workflow_run (after retag) ‚îÄ‚îÄ
          if [ "$EVENT" = "workflow_run" ]; then
            RETAG_CONCLUSION="${{ github.event.workflow_run.conclusion }}"
            RETAG_SHA="${{ github.event.workflow_run.head_sha }}"
            echo "üîó Retag workflow finished (conclusion=$RETAG_CONCLUSION, sha=$RETAG_SHA)"

            if [ "$RETAG_CONCLUSION" != "success" ]; then
              echo "‚è≠ Retag did not succeed ‚Äî skipping scan"
              echo "scan-all=false"   >> $GITHUB_OUTPUT
              echo "tool-count=0"     >> $GITHUB_OUTPUT
              echo "tools-json=[]"    >> $GITHUB_OUTPUT
              exit 0
            fi

            CHANGED_FILES=$(git diff --name-only "${RETAG_SHA}^" "$RETAG_SHA" -- 'bfx/*/release.json' 2>/dev/null || true)
          else
            # Manual changed-only
            echo "üîç Manual changed-only mode"
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'bfx/*/release.json' 2>/dev/null || true)
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "  ‚Üí No release.json changes detected ‚Äî nothing to scan"
            echo "scan-all=false"   >> $GITHUB_OUTPUT
            echo "tool-count=0"     >> $GITHUB_OUTPUT
            echo "tools-json=[]"    >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract unique tool names: bfx/<tool>/release.json ‚Üí <tool>
          TOOLS=$(echo "$CHANGED_FILES" | sed 's|^bfx/||; s|/release.json$||' | sort -u)
          TOOLS_JSON=$(echo "$TOOLS" | jq -R . | jq -sc .)
          COUNT=$(echo "$TOOLS_JSON" | jq length)

          echo "üõ† Tools to scan ($COUNT):"
          echo "$TOOLS" | sed 's/^/  ‚úì /'

          echo "scan-all=false"          >> $GITHUB_OUTPUT
          echo "tool-count=$COUNT"       >> $GITHUB_OUTPUT
          echo "tools-json=$TOOLS_JSON"  >> $GITHUB_OUTPUT

  # ‚îÄ‚îÄ Job 2: Scan each tool's images with Trivy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  scan:
    name: Trivy Scan
    runs-on: ubuntu-latest
    timeout-minutes: 180
    needs: detect-scope
    if: needs.detect-scope.outputs.tool-count > 0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pre-warm Trivy vulnerability database
        run: |
          echo "‚¨á Downloading Trivy vulnerability database..."
          mkdir -p ~/.cache/trivy
          docker run --rm \
            -v "$HOME/.cache/trivy:/root/.cache/trivy" \
            -e TRIVY_CACHE_DIR="/root/.cache/trivy" \
            aquasec/trivy:latest image --download-db-only
          echo "‚úì Database ready"

      - name: Scan tool images
        id: scan
        env:
          TOOLS_JSON: ${{ needs.detect-scope.outputs.tools-json }}
          ORG_NAME:   ${{ github.repository_owner }}
        run: |
          TOOL_COUNT=$(echo "$TOOLS_JSON" | jq -r 'length')
          echo "üî¨ Scanning $TOOL_COUNT tool(s)..."
          echo ""

          TOTAL_VULNS=0
          TOOLS_SCANNED=0
          TOOLS_WITH_VULNS=0
          SCAN_SUMMARY=""

          for tool in $(echo "$TOOLS_JSON" | jq -r '.[]'); do
            TOOLS_SCANNED=$((TOOLS_SCANNED + 1))
            RELEASE="bfx/$tool/release.json"
            RESULT_FILE="bfx/$tool/trivy-scan-results.json"

            echo "[$TOOLS_SCANNED/$TOOL_COUNT] $tool"

            # ‚îÄ‚îÄ Validate release.json ‚îÄ‚îÄ
            if [ ! -f "$RELEASE" ]; then
              echo "  ‚ö† No release.json ‚Äî skipping"
              continue
            fi
            if ! jq empty "$RELEASE" 2>/dev/null; then
              echo "  ‚ö† Invalid JSON ‚Äî skipping"
              continue
            fi

            IMAGES=$(jq -r '.images[]?' "$RELEASE" 2>/dev/null)
            if [ -z "$IMAGES" ]; then
              echo "  ‚ö† No images in release.json ‚Äî skipping"
              continue
            fi

            # ‚îÄ‚îÄ Initialise result structure ‚îÄ‚îÄ
            SLUG=$(echo "$tool" | tr '[:upper:]' '[:lower:]')
            echo "{
              \"tool\": \"$tool\",
              \"scan_timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
              \"workflow_run_id\": \"${{ github.run_id }}\",
              \"versions\": {},
              \"summary\": {\"total_versions_scanned\": 0, \"total_vulnerabilities\": 0}
            }" | jq . > "$RESULT_FILE"

            TOOL_VULN_COUNT=0
            VERSION_COUNT=0

            # ‚îÄ‚îÄ Scan each image ‚îÄ‚îÄ
            while IFS= read -r source_image; do
              [ -z "$source_image" ] && continue

              FULL_TAG="${source_image##*:}"
              SHORT_TAG="${FULL_TAG%%--*}"
              GHCR_URL="ghcr.io/${ORG_NAME}/products/bfx/${SLUG}:${SHORT_TAG}"

              if ! docker manifest inspect "$GHCR_URL" > /dev/null 2>&1; then
                echo "  ‚ö† Not in GHCR: $GHCR_URL ‚Äî skipping"
                continue
              fi

              echo "  ‚Üí Scanning $GHCR_URL ..."
              SAFE_NAME=$(echo "$GHCR_URL" | sed 's|[^a-zA-Z0-9._-]|_|g')
              SCAN_JSON="/tmp/trivy-${SAFE_NAME}.json"

              if timeout 15m docker run --rm \
                --memory=2g --cpus=2 \
                -v "/tmp:/output" \
                -v "$HOME/.cache/trivy:/root/.cache/trivy" \
                -e TRIVY_USERNAME="${{ github.actor }}" \
                -e TRIVY_PASSWORD="${{ secrets.GITHUB_TOKEN }}" \
                -e TRIVY_CACHE_DIR="/root/.cache/trivy" \
                aquasec/trivy:latest image \
                --format json \
                --severity CRITICAL,HIGH \
                --timeout 12m \
                --exit-code 0 \
                --skip-db-update \
                --scanners vuln \
                --output "/output/trivy-${SAFE_NAME}.json" \
                "$GHCR_URL"; then

                if jq empty "$SCAN_JSON" 2>/dev/null && [ "$(wc -c < "$SCAN_JSON" 2>/dev/null || echo 0)" -gt 10 ]; then
                  VULN_COUNT=$(jq '[.Results[]?.Vulnerabilities[]?] | length' "$SCAN_JSON" 2>/dev/null || echo 0)
                  echo "    ‚úì $VULN_COUNT vulnerabilities (CRITICAL/HIGH)"

                  # Extract vulnerabilities array from raw Trivy output
                  TEMP_VULNS=$(mktemp)
                  jq '[.Results[]?.Vulnerabilities[]?]' "$SCAN_JSON" > "$TEMP_VULNS" 2>/dev/null || echo "[]" > "$TEMP_VULNS"

                  # Merge into the organised result file
                  jq --arg tag "$SHORT_TAG" \
                     --arg image "$GHCR_URL" \
                     --argjson count "$VULN_COUNT" \
                     --slurpfile vulns "$TEMP_VULNS" \
                     '.versions[$tag] = {
                        "image": $image,
                        "vulnerabilities": $vulns[0],
                        "vulnerability_count": $count
                      }' "$RESULT_FILE" > "${RESULT_FILE}.tmp" && mv "${RESULT_FILE}.tmp" "$RESULT_FILE"

                  rm -f "$TEMP_VULNS"
                  VERSION_COUNT=$((VERSION_COUNT + 1))
                  TOOL_VULN_COUNT=$((TOOL_VULN_COUNT + VULN_COUNT))
                else
                  echo "    ‚úó Trivy produced empty/invalid output"
                fi
              else
                echo "    ‚úó Scan failed"
              fi

              # Clean up scan file to save disk
              rm -f "$SCAN_JSON"
            done <<< "$IMAGES"

            # ‚îÄ‚îÄ Update summary in result file ‚îÄ‚îÄ
            jq --argjson vc "$VERSION_COUNT" --argjson tv "$TOOL_VULN_COUNT" \
              '.summary.total_versions_scanned = $vc | .summary.total_vulnerabilities = $tv' \
              "$RESULT_FILE" > "${RESULT_FILE}.tmp" && mv "${RESULT_FILE}.tmp" "$RESULT_FILE"

            TOTAL_VULNS=$((TOTAL_VULNS + TOOL_VULN_COUNT))
            if [ "$TOOL_VULN_COUNT" -gt 0 ]; then
              TOOLS_WITH_VULNS=$((TOOLS_WITH_VULNS + 1))
            fi

            # Accumulate per-tool summary line
            CRITICAL=$(jq '[.versions[].vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$RESULT_FILE" 2>/dev/null || echo 0)
            HIGH=$(jq '[.versions[].vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$RESULT_FILE" 2>/dev/null || echo 0)
            SCAN_SUMMARY="${SCAN_SUMMARY}| ${tool} | ${VERSION_COUNT} | ${CRITICAL} | ${HIGH} |\n"

            echo "  ‚úì Done: $VERSION_COUNT version(s), $TOOL_VULN_COUNT vuln(s)"
            echo ""

            # Periodic docker cleanup (every 10 tools)
            if [ $((TOOLS_SCANNED % 10)) -eq 0 ]; then
              docker system prune -f > /dev/null 2>&1 || true
            fi
          done

          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìä Scan Summary"
          echo "  ‚Üí Tools scanned:          $TOOLS_SCANNED"
          echo "  ‚Üí Tools with vulns:       $TOOLS_WITH_VULNS"
          echo "  ‚Üí Total vulnerabilities:  $TOTAL_VULNS"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

          echo "tools-scanned=$TOOLS_SCANNED"       >> $GITHUB_OUTPUT
          echo "tools-with-vulns=$TOOLS_WITH_VULNS" >> $GITHUB_OUTPUT
          echo "total-vulns=$TOTAL_VULNS"            >> $GITHUB_OUTPUT

          # Write summary table to a file so the PR step can read it
          printf "$SCAN_SUMMARY" > /tmp/scan-summary-table.txt
          echo "scan-summary-file=/tmp/scan-summary-table.txt" >> $GITHUB_OUTPUT

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-scan-results
          path: bfx/*/trivy-scan-results.json
          retention-days: 90
          compression-level: 6
        continue-on-error: true

    outputs:
      tools-scanned:    ${{ steps.scan.outputs.tools-scanned }}
      tools-with-vulns: ${{ steps.scan.outputs.tools-with-vulns }}
      total-vulns:      ${{ steps.scan.outputs.total-vulns }}
      scan-summary-file: ${{ steps.scan.outputs.scan-summary-file }}

  # ‚îÄ‚îÄ Job 3: Create PR with scan results ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  create-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-scope, scan]
    if: needs.scan.outputs.total-vulns > 0

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download scan results
        uses: actions/download-artifact@v7
        with:
          name: trivy-scan-results
          path: scan-results/

      - name: Create PR with results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TOOLS_JSON:   ${{ needs.detect-scope.outputs.tools-json }}
          TOOL_COUNT:   ${{ needs.detect-scope.outputs.tool-count }}
          TOTAL_VULNS:  ${{ needs.scan.outputs.total-vulns }}
          TOOLS_WITH_VULNS: ${{ needs.scan.outputs.tools-with-vulns }}
        run: |
          echo "üìù Creating PR with scan results..."

          # ‚îÄ‚îÄ Determine branch name ‚îÄ‚îÄ
          DATE=$(date +%Y-%m-%d)
          if [ "$TOOL_COUNT" -eq 1 ]; then
            SINGLE_TOOL=$(echo "$TOOLS_JSON" | jq -r '.[0]')
            BRANCH_NAME="trivy-scan-${SINGLE_TOOL}-${DATE}"
          else
            BRANCH_NAME="trivy-scan-${DATE}"
          fi

          # ‚îÄ‚îÄ Copy results into bfx/<tool>/ ‚îÄ‚îÄ
          COPIED=0
          for result_file in scan-results/*/trivy-scan-results.json; do
            [ -f "$result_file" ] || continue
            # Path is scan-results/<tool>/trivy-scan-results.json
            TOOL_NAME=$(basename "$(dirname "$result_file")")
            TARGET="bfx/$TOOL_NAME/trivy-scan-results.json"

            if [ -d "bfx/$TOOL_NAME" ]; then
              cp "$result_file" "$TARGET"
              COPIED=$((COPIED + 1))
              echo "  ‚úì $TOOL_NAME"
            else
              echo "  ‚ö† No bfx/$TOOL_NAME directory ‚Äî skipping"
            fi
          done

          if [ "$COPIED" -eq 0 ]; then
            echo "‚ö† No results to commit ‚Äî exiting"
            exit 0
          fi

          echo "  ‚Üí Copied $COPIED result files"

          # ‚îÄ‚îÄ Git: branch, commit, push ‚îÄ‚îÄ
          git config user.name  'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          # Delete remote branch if it already exists (stale from previous run today)
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
          git checkout -b "$BRANCH_NAME"

          git add bfx/*/trivy-scan-results.json
          if ! git diff --staged --quiet; then
            git commit -m "üîí Trivy security scan results ‚Äî $DATE

Scanned $TOOL_COUNT tool(s), found $TOTAL_VULNS vulnerabilities (CRITICAL/HIGH)."
            git push origin "$BRANCH_NAME"
          else
            echo "‚ö† No changes to commit ‚Äî scan results identical to main"
            exit 0
          fi

          # ‚îÄ‚îÄ Build PR body ‚îÄ‚îÄ
          PR_BODY="## üîí Trivy Security Scan Results ‚Äî $DATE

### üìä Summary
- **Tools scanned**: $TOOL_COUNT
- **Tools with vulnerabilities**: $TOOLS_WITH_VULNS
- **Total CRITICAL + HIGH vulnerabilities**: $TOTAL_VULNS

### üìã Per-Tool Results
| Tool | Versions | CRITICAL | HIGH |
|------|----------|----------|------|
"
          # Read per-tool data from result files
          for result_file in scan-results/*/trivy-scan-results.json; do
            [ -f "$result_file" ] || continue
            TOOL_NAME=$(basename "$(dirname "$result_file")")
            VERSIONS=$(jq -r '.summary.total_versions_scanned' "$result_file" 2>/dev/null || echo 0)
            CRITICAL=$(jq '[.versions[].vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$result_file" 2>/dev/null || echo 0)
            HIGH=$(jq '[.versions[].vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$result_file" 2>/dev/null || echo 0)
            PR_BODY="${PR_BODY}| ${TOOL_NAME} | ${VERSIONS} | ${CRITICAL} | ${HIGH} |
"
          done

          PR_BODY="${PR_BODY}
### üîß What to do
1. Review the \`trivy-scan-results.json\` files for each affected tool
2. Prioritise **CRITICAL** vulnerabilities for immediate remediation
3. Plan container image updates for affected versions

_Automated by [Trivy Security Scan](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})_"

          # ‚îÄ‚îÄ PR title ‚îÄ‚îÄ
          if [ "$TOOL_COUNT" -eq 1 ]; then
            PR_TITLE="üîí Security scan: ${SINGLE_TOOL} ‚Äî $DATE"
          else
            PR_TITLE="üîí Security scan: $TOOLS_WITH_VULNS of $TOOL_COUNT tools have vulnerabilities ‚Äî $DATE"
          fi

          # ‚îÄ‚îÄ Create PR ‚îÄ‚îÄ
          if gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME"; then
            echo "‚úÖ Pull request created"

            # Best-effort reviewer assignment
            gh pr edit "$BRANCH_NAME" --add-reviewer "gkr0110" 2>/dev/null \
              && echo "  ‚úì Reviewer: gkr0110" \
              || echo "  ‚ö† Could not add gkr0110"
            gh pr edit "$BRANCH_NAME" --add-reviewer "vipin-bc" 2>/dev/null \
              && echo "  ‚úì Reviewer: vipin-bc" \
              || echo "  ‚ö† Could not add vipin-bc"

            # Best-effort labels
            gh pr edit "$BRANCH_NAME" --add-label "security" 2>/dev/null || true
            gh pr edit "$BRANCH_NAME" --add-label "trivy-scan" 2>/dev/null || true
          else
            echo "‚úó Failed to create PR"
            exit 1
          fi
